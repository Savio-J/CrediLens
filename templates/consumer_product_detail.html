{% extends "base.html" %}
{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Back Button -->
    <a href="/consumer" class="text-gray-500 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 mb-6 inline-block flex items-center">
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg> 
        Back to Products
    </a>

    <!-- Product Header -->
    <div class="glass-panel p-8 mb-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
            <div class="flex-1">
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">{{ product.product_name }}</h1>
                <p class="text-lg text-gray-600 dark:text-slate-300">{{ product.company_name }}</p>
                {% if product.category %}
                <span class="inline-block mt-2 px-3 py-1 bg-blue-100 dark:bg-blue-900/40 text-blue-800 dark:text-blue-300 text-sm font-medium rounded-full">{{ product.category }}</span>
                {% endif %}
                {% if product.blockchain_tx %}
                <div class="inline-flex items-center mt-2 ml-2 px-3 py-1 bg-green-100 dark:bg-green-900/40 text-green-800 dark:text-green-300 text-sm font-medium rounded-full">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                    Blockchain Verified
                </div>
                {% endif %}
                {% if product.verification_status == 'approved' %}
                <div class="inline-flex items-center mt-2 ml-2 px-3 py-1 bg-purple-100 dark:bg-purple-900/40 text-purple-800 dark:text-purple-300 text-sm font-medium rounded-full">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Verified Seller
                </div>
                {% endif %}
                <!-- Compare Button -->
                <a href="/consumer/compare?ids={{ product.id }}" class="inline-flex items-center mt-2 ml-2 px-3 py-1 bg-purple-100 dark:bg-purple-900/40 text-purple-800 dark:text-purple-300 text-sm font-medium rounded-full hover:bg-purple-200 dark:hover:bg-purple-800/50 transition">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    Compare This
                </a>
            </div>
            
            <!-- Score Display -->
            <div class="text-center">
                <div class="text-sm uppercase tracking-wide text-gray-500 dark:text-slate-400 font-semibold mb-2">Credibility Score</div>
                {% if product.ideal_score %}
                    {% if product.ideal_score >= 80 %}
                    <div class="bg-green-100 dark:bg-green-900/40 text-green-800 dark:text-green-300 px-8 py-4 rounded-xl font-bold text-4xl shadow-lg">{{ "%.1f"|format(product.ideal_score) }}</div>
                    <p class="text-sm text-green-700 dark:text-green-400 mt-2 font-medium">Excellent</p>
                    {% elif product.ideal_score >= 60 %}
                    <div class="bg-yellow-100 dark:bg-yellow-900/40 text-yellow-800 dark:text-yellow-300 px-8 py-4 rounded-xl font-bold text-4xl shadow-lg">{{ "%.1f"|format(product.ideal_score) }}</div>
                    <p class="text-sm text-yellow-700 dark:text-yellow-400 mt-2 font-medium">Good</p>
                    {% else %}
                    <div class="bg-red-100 dark:bg-red-900/40 text-red-800 dark:text-red-300 px-8 py-4 rounded-xl font-bold text-4xl shadow-lg">{{ "%.1f"|format(product.ideal_score) }}</div>
                    <p class="text-sm text-red-700 dark:text-red-400 mt-2 font-medium">Average</p>
                    {% endif %}
                {% else %}
                <div class="bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-slate-300 px-8 py-4 rounded-xl font-bold text-4xl shadow-lg">N/A</div>
                <p class="text-sm text-gray-500 dark:text-slate-400 mt-2 font-medium">Not Scored</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Technical Specifications -->
    <div class="glass-panel p-8 mb-6">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
            <svg class="w-6 h-6 mr-2 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path></svg>
            Technical Specifications
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {% if product.processor_score %}
            <div class="border-l-4 border-blue-500 pl-4 py-2">
                <div class="text-sm text-gray-500 dark:text-slate-400 uppercase tracking-wide font-semibold">Processor Score</div>
                <div class="text-2xl font-bold text-gray-900 dark:text-white mt-1">{{ product.processor_score|int }}</div>
                <div class="text-xs text-gray-400 dark:text-slate-500 mt-1">AnTuTu/Geekbench</div>
            </div>
            {% endif %}

            {% if product.ram_gb %}
            <div class="border-l-4 border-purple-500 pl-4 py-2">
                <div class="text-sm text-gray-500 dark:text-slate-400 uppercase tracking-wide font-semibold">RAM</div>
                <div class="text-2xl font-bold text-gray-900 dark:text-white mt-1">{{ product.ram_gb }} GB</div>
                <div class="text-xs text-gray-400 dark:text-slate-500 mt-1">System Memory</div>
            </div>
            {% endif %}

            {% if product.storage_gb %}
            <div class="border-l-4 border-green-500 pl-4 py-2">
                <div class="text-sm text-gray-500 dark:text-slate-400 uppercase tracking-wide font-semibold">Storage</div>
                <div class="text-2xl font-bold text-gray-900 dark:text-white mt-1">{{ product.storage_gb }} GB</div>
                <div class="text-xs text-gray-400 dark:text-slate-500 mt-1">Internal Storage</div>
            </div>
            {% endif %}

            {% if product.battery_mah %}
            <div class="border-l-4 border-yellow-500 pl-4 py-2">
                <div class="text-sm text-gray-500 dark:text-slate-400 uppercase tracking-wide font-semibold">Battery</div>
                <div class="text-2xl font-bold text-gray-900 dark:text-white mt-1">{{ product.battery_mah }} mAh</div>
                <div class="text-xs text-gray-400 dark:text-slate-500 mt-1">Battery Capacity</div>
            </div>
            {% endif %}

            {% if product.screen_inches %}
            <div class="border-l-4 border-indigo-500 pl-4 py-2">
                <div class="text-sm text-gray-500 uppercase tracking-wide font-semibold">Screen Size</div>
                <div class="text-2xl font-bold text-gray-900 mt-1">{{ product.screen_inches }}"</div>
                <div class="text-xs text-gray-400 mt-1">Display Diagonal</div>
            </div>
            {% endif %}

            {% if product.camera_mp %}
            <div class="border-l-4 border-pink-500 pl-4 py-2">
                <div class="text-sm text-gray-500 uppercase tracking-wide font-semibold">Camera</div>
                <div class="text-2xl font-bold text-gray-900 mt-1">{{ product.camera_mp }} MP</div>
                <div class="text-xs text-gray-400 mt-1">Main Camera</div>
            </div>
            {% endif %}

            {% if product.price_usd %}
            <div class="border-l-4 border-red-500 pl-4 py-2">
                <div class="text-sm text-gray-500 uppercase tracking-wide font-semibold">Price</div>
                <div class="text-2xl font-bold text-gray-900 mt-1">${{ product.price_usd }}</div>
                <div class="text-xs text-gray-400 mt-1">USD</div>
            </div>
            {% endif %}

            {% if product.weight_g %}
            <div class="border-l-4 border-gray-500 pl-4 py-2">
                <div class="text-sm text-gray-500 uppercase tracking-wide font-semibold">Weight</div>
                <div class="text-2xl font-bold text-gray-900 mt-1">{{ product.weight_g }} g</div>
                <div class="text-xs text-gray-400 mt-1">Device Weight</div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Component Details -->
    <div class="glass-panel p-8 mb-6">
        <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
            <svg class="w-6 h-6 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            Component Details (Manufacturer & Model)
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {% if product.processor_model %}
            <div class="border-l-4 border-blue-500 pl-4 py-2 bg-blue-50 rounded">
                <div class="text-sm text-gray-500 uppercase tracking-wide font-semibold">Processor Model</div>
                <div class="text-lg font-semibold text-gray-900 mt-2">{{ product.processor_model }}</div>
            </div>
            {% endif %}

            {% if product.ram_type %}
            <div class="border-l-4 border-purple-500 pl-4 py-2 bg-purple-50 rounded">
                <div class="text-sm text-gray-500 uppercase tracking-wide font-semibold">RAM Type</div>
                <div class="text-lg font-semibold text-gray-900 mt-2">{{ product.ram_type }}</div>
            </div>
            {% endif %}

            {% if product.storage_type %}
            <div class="border-l-4 border-green-500 pl-4 py-2 bg-green-50 rounded">
                <div class="text-sm text-gray-500 uppercase tracking-wide font-semibold">Storage Type</div>
                <div class="text-lg font-semibold text-gray-900 mt-2">{{ product.storage_type }}</div>
            </div>
            {% endif %}

            {% if product.battery_tech %}
            <div class="border-l-4 border-yellow-500 pl-4 py-2 bg-yellow-50 rounded">
                <div class="text-sm text-gray-500 uppercase tracking-wide font-semibold">Battery Technology</div>
                <div class="text-lg font-semibold text-gray-900 mt-2">{{ product.battery_tech }}</div>
                {% if product.charging_watt %}
                <div class="text-xs text-gray-500 mt-1">{{ product.charging_watt }}W Charging</div>
                {% endif %}
            </div>
            {% endif %}

            {% if product.display_type %}
            <div class="border-l-4 border-indigo-500 pl-4 py-2 bg-indigo-50 rounded">
                <div class="text-sm text-gray-500 uppercase tracking-wide font-semibold">Display Type</div>
                <div class="text-lg font-semibold text-gray-900 mt-2">{{ product.display_type }}</div>
                {% if product.refresh_rate_hz %}
                <div class="text-xs text-gray-500 mt-1">{{ product.refresh_rate_hz }} Hz</div>
                {% endif %}
            </div>
            {% endif %}

            {% if product.camera_sensor_main %}
            <div class="border-l-4 border-pink-500 pl-4 py-2 bg-pink-50 rounded">
                <div class="text-sm text-gray-500 uppercase tracking-wide font-semibold">Main Camera Sensor</div>
                <div class="text-lg font-semibold text-gray-900 mt-2">{{ product.camera_sensor_main }}</div>
            </div>
            {% endif %}

            {% if product.camera_sensor_ultra %}
            <div class="border-l-4 border-red-500 pl-4 py-2 bg-red-50 rounded">
                <div class="text-sm text-gray-500 uppercase tracking-wide font-semibold">Ultra-wide Camera Sensor</div>
                <div class="text-lg font-semibold text-gray-900 mt-2">{{ product.camera_sensor_ultra }}</div>
            </div>
            {% endif %}

            {% if product.camera_sensor_telephoto %}
            <div class="border-l-4 border-orange-500 pl-4 py-2 bg-orange-50 rounded">
                <div class="text-sm text-gray-500 uppercase tracking-wide font-semibold">Telephoto Camera Sensor</div>
                <div class="text-lg font-semibold text-gray-900 mt-2">{{ product.camera_sensor_telephoto }}</div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Where to Buy -->
    {% if product.link_amazon or product.link_flipkart or product.link_official or product.link_other %}
    <div class="glass-panel p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
            <svg class="w-6 h-6 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
            Where to Buy
        </h2>
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            {% if product.link_amazon %}
            <a href="{{ product.link_amazon }}" target="_blank" rel="noopener noreferrer"
               class="flex flex-col items-center p-4 bg-orange-50 hover:bg-orange-100 rounded-lg border border-orange-200 transition group">
                <span class="text-3xl mb-2">üõí</span>
                <span class="font-medium text-orange-700 group-hover:text-orange-900">Amazon</span>
                <span class="text-xs text-gray-500 mt-1">View Product ‚Üí</span>
            </a>
            {% endif %}
            
            {% if product.link_flipkart %}
            <a href="{{ product.link_flipkart }}" target="_blank" rel="noopener noreferrer"
               class="flex flex-col items-center p-4 bg-yellow-50 hover:bg-yellow-100 rounded-lg border border-yellow-200 transition group">
                <span class="text-3xl mb-2">üõçÔ∏è</span>
                <span class="font-medium text-yellow-700 group-hover:text-yellow-900">Flipkart</span>
                <span class="text-xs text-gray-500 mt-1">View Product ‚Üí</span>
            </a>
            {% endif %}
            
            {% if product.link_official %}
            <a href="{{ product.link_official }}" target="_blank" rel="noopener noreferrer"
               class="flex flex-col items-center p-4 bg-blue-50 hover:bg-blue-100 rounded-lg border border-blue-200 transition group">
                <span class="text-3xl mb-2">üè¢</span>
                <span class="font-medium text-blue-700 group-hover:text-blue-900">Official Store</span>
                <span class="text-xs text-gray-500 mt-1">View Product ‚Üí</span>
            </a>
            {% endif %}
            
            {% if product.link_other %}
            <a href="{{ product.link_other }}" target="_blank" rel="noopener noreferrer"
               class="flex flex-col items-center p-4 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition group">
                <span class="text-3xl mb-2">üîó</span>
                <span class="font-medium text-gray-700 group-hover:text-gray-900">Other</span>
                <span class="text-xs text-gray-500 mt-1">View Product ‚Üí</span>
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Price Tracking & Alerts -->
    <div class="glass-panel p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
            <svg class="w-6 h-6 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path></svg>
            Price Tracking
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Price History Chart -->
            <div>
                <h3 class="font-medium text-gray-700 mb-3">Price History</h3>
                <div class="bg-gray-50 rounded-lg p-4 h-48 flex items-center justify-center">
                    <canvas id="priceChart" class="w-full h-full"></canvas>
                </div>
            </div>
            
            <!-- Price Alert Form -->
            <div>
                <h3 class="font-medium text-gray-700 mb-3">üîî Set Price Alert</h3>
                <div class="bg-gray-50 rounded-lg p-4">
                    <p class="text-sm text-gray-600 mb-3">Get notified when the price drops below your target.</p>
                    
                    <div class="mb-3">
                        <span class="text-sm text-gray-500">Current Price:</span>
                        <span class="text-lg font-bold text-gray-900">${{ "%.2f"|format(product.price_usd) }}</span>
                    </div>
                    
                    {% if current_user.is_authenticated and current_user.role == 'consumer' %}
                    <form action="{{ url_for('set_price_alert', product_id=product.id) }}" method="POST">
                        <div class="flex gap-2">
                            <div class="relative flex-1">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                                <input type="number" name="target_price" step="0.01" min="1" 
                                       max="{{ product.price_usd - 1 }}"
                                       placeholder="{{ (product.price_usd * 0.9)|int }}"
                                       class="w-full pl-7 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                       required>
                            </div>
                            <button type="submit" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition">
                                Set Alert
                            </button>
                        </div>
                    </form>
                    <a href="{{ url_for('my_price_alerts') }}" class="inline-block mt-3 text-sm text-purple-600 hover:text-purple-800">
                        View my alerts ‚Üí
                    </a>
                    {% else %}
                    <p class="text-sm text-gray-500">
                        <a href="{{ url_for('login') }}" class="text-purple-600 hover:underline">Log in</a> as a consumer to set price alerts.
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Blockchain Verification (Consumer View) -->
    {% if product.blockchain_tx %}
    <div class="glass-panel p-6 mb-6 bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center mr-4">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-green-800">‚úì Blockchain Verified Score</h3>
                    <p class="text-sm text-green-600">This product's credibility score is stored on the {{ product.blockchain_network|capitalize }} blockchain</p>
                </div>
            </div>
            <button onclick="verifyScore({{ product.id }})" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium">
                üîç Verify Now
            </button>
        </div>
        <div id="consumer-verify-result" class="mt-4 hidden"></div>
    </div>
    {% endif %}

    <!-- User Reviews Section -->
    <div class="glass-panel p-8 mb-6">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-gray-900 flex items-center">
                <svg class="w-6 h-6 mr-2 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                User Reviews
            </h2>
            {% if product.average_user_rating %}
            <div class="text-right">
                <div class="text-3xl font-bold text-yellow-600">{{ product.average_user_rating }}/5</div>
                <div class="text-sm text-gray-500">{{ product.reviews|length }} review{{ 's' if product.reviews|length != 1 else '' }}</div>
            </div>
            {% endif %}
        </div>

        <!-- Review Form -->
        <div class="bg-gray-50 rounded-lg p-6 mb-6">
            {% if user_review %}
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-gray-900">Edit Your Review</h3>
                <span class="text-xs text-gray-500 bg-gray-200 px-2 py-1 rounded">You already reviewed this product</span>
            </div>
            {% else %}
            <h3 class="font-semibold text-gray-900 mb-4">Rate this product</h3>
            {% endif %}
            
            <form method="POST" action="{{ url_for('submit_review', product_id=product.id) }}">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <!-- Display Rating -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Display Quality</label>
                        <div class="star-rating-input flex-row-reverse justify-end items-center space-x-reverse space-x-1">
                            {% for i in range(5, 0, -1) %}
                            <input type="radio" id="display_{{ i }}" name="display_rating" value="{{ i }}" class="hidden star-input" {% if user_review and user_review.display_rating == i %}checked{% endif %} required>
                            <label for="display_{{ i }}" class="cursor-pointer text-2xl text-gray-300">‚òÖ</label>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Performance Rating -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Performance</label>
                        <div class="star-rating-input flex-row-reverse justify-end items-center space-x-reverse space-x-1">
                            {% for i in range(5, 0, -1) %}
                            <input type="radio" id="performance_{{ i }}" name="performance_rating" value="{{ i }}" class="hidden star-input" {% if user_review and user_review.performance_rating == i %}checked{% endif %} required>
                            <label for="performance_{{ i }}" class="cursor-pointer text-2xl text-gray-300">‚òÖ</label>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Battery Rating -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Battery Life</label>
                        <div class="star-rating-input flex-row-reverse justify-end items-center space-x-reverse space-x-1">
                            {% for i in range(5, 0, -1) %}
                            <input type="radio" id="battery_{{ i }}" name="battery_rating" value="{{ i }}" class="hidden star-input" {% if user_review and user_review.battery_rating == i %}checked{% endif %} required>
                            <label for="battery_{{ i }}" class="cursor-pointer text-2xl text-gray-300">‚òÖ</label>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Camera Rating -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Camera Quality</label>
                        <div class="star-rating-input flex-row-reverse justify-end items-center space-x-reverse space-x-1">
                            {% for i in range(5, 0, -1) %}
                            <input type="radio" id="camera_{{ i }}" name="camera_rating" value="{{ i }}" class="hidden star-input" {% if user_review and user_review.camera_rating == i %}checked{% endif %} required>
                            <label for="camera_{{ i }}" class="cursor-pointer text-2xl text-gray-300">‚òÖ</label>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Design Rating -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Design & Build Quality</label>
                        <div class="star-rating-input flex-row-reverse justify-end items-center space-x-reverse space-x-1">
                            {% for i in range(5, 0, -1) %}
                            <input type="radio" id="design_{{ i }}" name="design_rating" value="{{ i }}" class="hidden star-input" {% if user_review and user_review.design_rating == i %}checked{% endif %} required>
                            <label for="design_{{ i }}" class="cursor-pointer text-2xl text-gray-300">‚òÖ</label>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Text Review (Required for Emotion Detection) -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Your Review <span class="text-red-500">*</span>
                        <span class="text-xs text-gray-500 font-normal">(AI analyzes your text to detect sentiment)</span>
                    </label>
                    <textarea name="review_text" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Share your experience with this product..." required>{{ user_review.review_text if user_review else '' }}</textarea>
                </div>

                <button type="submit" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                    {% if user_review %}Update Review{% else %}Submit Review{% endif %}
                </button>
            </form>
        </div>

        <!-- Existing Reviews -->
        {% if reviews %}
        <div class="space-y-4">
            <h3 class="font-semibold text-gray-900 mb-3">Customer Reviews</h3>
            {% for review in reviews %}
            <div class="border border-gray-200 rounded-lg p-4 bg-white {% if review.credibility_flag == 'suspicious' %}border-l-4 border-l-orange-400{% elif review.credibility_flag == 'genuine' and review.credibility_score and review.credibility_score > 0.8 %}border-l-4 border-l-green-400{% endif %} {% if review.user_id == current_user.id %}ring-2 ring-blue-300{% endif %}">
                <div class="flex items-start justify-between mb-3">
                    <div>
                        <div class="flex items-center gap-2">
                            <!-- Display username from linked User account -->
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white text-sm font-bold mr-2">
                                    {{ review.user.username[0]|upper if review.user else '?' }}
                                </div>
                                <div class="font-semibold text-gray-900">
                                    {{ review.user.username if review.user else 'Unknown User' }}
                                    {% if review.user_id == current_user.id %}
                                    <span class="text-xs text-blue-600 font-normal">(You)</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% if review.credibility_flag == 'genuine' and review.credibility_score and review.credibility_score > 0.8 %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                                Verified Sentiment
                            </span>
                            {% elif review.credibility_flag == 'suspicious' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                                <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                                Sentiment Mismatch
                            </span>
                            {% endif %}
                        </div>
                        <div class="text-xs text-gray-500 ml-10">
                            {{ review.timestamp.strftime('%B %d, %Y') }}
                            {% if review.updated_at %}
                            <span class="text-gray-400">(edited)</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-bold text-yellow-600">{{ review.average_rating }}/5</div>
                        <div class="flex text-yellow-500">
                            {% for i in range(review.average_rating|int) %}‚òÖ{% endfor %}
                            {% if review.average_rating % 1 >= 0.5 %}¬Ω{% endif %}
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-6 gap-2 text-xs mb-3">
                    <div class="text-center">
                        <div class="text-gray-600">Display</div>
                        <div class="font-semibold text-gray-900">{{ review.display_rating }}/5</div>
                    </div>
                    <div class="text-center">
                        <div class="text-gray-600">Performance</div>
                        <div class="font-semibold text-gray-900">{{ review.performance_rating }}/5</div>
                    </div>
                    <div class="text-center">
                        <div class="text-gray-600">Battery</div>
                        <div class="font-semibold text-gray-900">{{ review.battery_rating }}/5</div>
                    </div>
                    <div class="text-center">
                        <div class="text-gray-600">Camera</div>
                        <div class="font-semibold text-gray-900">{{ review.camera_rating }}/5</div>
                    </div>
                    <div class="text-center">
                        <div class="text-gray-600">Design</div>
                        <div class="font-semibold text-gray-900">{{ review.design_rating }}/5</div>
                    </div>
                    {% if review.emotion_label %}
                    <div class="text-center">
                        <div class="text-gray-600">Emotion</div>
                        <div class="font-semibold capitalize {% if review.emotion_label in ['joy'] %}text-green-600{% elif review.emotion_label in ['neutral', 'surprise'] %}text-yellow-600{% else %}text-red-600{% endif %}">
                            {{ review.emotion_label }}
                            {% if review.emotion_confidence %}
                            <span class="text-gray-400 text-[10px]">({{ (review.emotion_confidence * 100)|int }}%)</span>
                            {% endif %}
                        </div>
                    </div>
                    {% elif review.user_emotion %}
                    <div class="text-center">
                        <div class="text-gray-600">Emotion</div>
                        <div class="font-semibold {% if review.user_emotion >= 4 %}text-green-600{% elif review.user_emotion >= 3 %}text-yellow-600{% else %}text-red-600{% endif %}">{{ review.user_emotion }}/5</div>
                    </div>
                    {% endif %}
                </div>

                {% if review.review_text %}
                <p class="text-gray-700 text-sm italic">"{{ review.review_text }}"</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center text-gray-500 py-8">
            <p>No reviews yet. Be the first to review this product!</p>
        </div>
        {% endif %}
    </div>

    <!-- Product Information -->
    <div class="glass-panel p-8 mb-6">
        <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
            <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            Product Information
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            {% if product.batch_number %}
            <div class="flex justify-between py-2 border-b border-gray-200">
                <span class="text-gray-600">Batch Number:</span>
                <span class="font-medium text-gray-900">{{ product.batch_number }}</span>
            </div>
            {% endif %}
            
            <div class="flex justify-between py-2 border-b border-gray-200">
                <span class="text-gray-600">Product ID:</span>
                <span class="font-medium text-gray-900">#{{ product.id }}</span>
            </div>
        </div>
    </div>

    <!-- QR Code -->
    {% if product.qr_code_path %}
    <div class="glass-panel p-8 text-center">
        <h2 class="text-xl font-bold text-gray-900 mb-4">Product QR Code</h2>
        <p class="text-sm text-gray-500 mb-6">Scan this code to quickly access product details</p>
        <div class="inline-block bg-white p-4 rounded-lg shadow-md">
            <img src="/{{ product.qr_code_path }}" alt="QR Code" class="w-48 h-48 mx-auto">
        </div>
    </div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Load price history chart
async function loadPriceChart() {
    try {
        const response = await fetch('/api/product/{{ product.id }}/price-history');
        const data = await response.json();
        
        const ctx = document.getElementById('priceChart').getContext('2d');
        
        // Format dates for display
        const labels = data.history.map(h => {
            const date = new Date(h.date);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });
        
        const prices = data.history.map(h => h.price);
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Price ($)',
                    data: prices,
                    borderColor: '#8b5cf6',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 4,
                    pointBackgroundColor: '#8b5cf6'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: value => '$' + value
                        }
                    }
                }
            }
        });
    } catch (error) {
        document.getElementById('priceChart').parentElement.innerHTML = 
            '<p class="text-gray-500 text-center">Price history not available</p>';
    }
}

loadPriceChart();

async function verifyScore(productId) {
    const resultDiv = document.getElementById('consumer-verify-result');
    resultDiv.classList.remove('hidden');
    resultDiv.innerHTML = '<div class="text-gray-600 text-sm">üîÑ Verifying blockchain record...</div>';
    
    try {
        const response = await fetch(`/api/blockchain/verify/${productId}`);
        const data = await response.json();
        
        if (data.verified) {
            resultDiv.innerHTML = `
                <div class="bg-white border border-green-300 rounded-lg p-4">
                    <div class="font-bold text-green-800 mb-2">‚úì Verification Successful!</div>
                    <div class="text-sm text-green-700 space-y-1">
                        <p>‚úì The credibility score <strong>${data.score}</strong> is authentic</p>
                        <p>‚úì Data matches blockchain record from ${data.timestamp}</p>
                        <p>‚úì No tampering detected</p>
                    </div>
                    ${data.explorer_url ? `<a href="${data.explorer_url}" target="_blank" class="inline-block mt-2 text-indigo-600 hover:text-indigo-800 text-sm">View on Etherscan ‚Üí</a>` : ''}
                </div>
            `;
        } else {
            resultDiv.innerHTML = `
                <div class="bg-white border border-red-300 rounded-lg p-4">
                    <div class="font-bold text-red-800 mb-2">‚ö† Verification Warning</div>
                    <div class="text-sm text-red-700">
                        <p>The current data does not match the blockchain record.</p>
                        <p>This product may have been modified since registration.</p>
                    </div>
                </div>
            `;
        }
    } catch (error) {
        resultDiv.innerHTML = `
            <div class="bg-white border border-red-300 rounded-lg p-4">
                <div class="font-bold text-red-800">Verification Error</div>
                <div class="text-sm text-red-700">${error.message}</div>
            </div>
        `;
    }
}
</script>
{% endblock %}
