{% extends "base.html" %}
{% block content %}
<div class="max-w-2xl mx-auto">
    <!-- Back Button -->
    <a href="/consumer" class="text-gray-500 hover:text-blue-600 mb-6 inline-block flex items-center">
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg> 
        Back to Dashboard
    </a>

    <div class="text-center mb-6">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full mb-4">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-900 mb-2">AI Phone Scanner</h2>
        <p class="text-gray-500">Point your camera at any smartphone and our AI will identify it</p>
        <div class="inline-flex items-center mt-2 px-3 py-1 bg-purple-100 text-purple-700 text-sm rounded-full">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
            Powered by Google Gemini AI
        </div>
    </div>
    
    <!-- Camera Container -->
    <div class="glass-panel p-4 bg-gray-900 rounded-xl overflow-hidden relative mb-6">
        <!-- Video Element (Camera Feed) -->
        <video id="videoElement" class="w-full rounded-lg aspect-video object-cover" style="display:none;" autoplay playsinline></video>
        
        <!-- Canvas for capture -->
        <canvas id="canvasElement" class="hidden"></canvas>
        
        <!-- Placeholder (shown before camera starts) -->
        <div id="placeholder" class="text-gray-400 flex flex-col items-center justify-center aspect-video bg-gray-800 rounded-lg">
            <svg class="w-20 h-20 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
            </svg>
            <span class="text-lg">Point camera at a smartphone</span>
            <span class="text-sm mt-1 opacity-70">Click "Start Camera" to begin</span>
        </div>
        
        <!-- Scanning Overlay -->
        <div id="scanningOverlay" class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center" style="display:none;">
            <div class="text-center text-white">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-white border-t-transparent mb-4"></div>
                <p class="text-lg font-semibold">Analyzing image...</p>
                <p class="text-sm opacity-70">AI is identifying the phone</p>
            </div>
        </div>
        
        <!-- AI Scan Frame -->
        <div id="scanFrame" class="absolute inset-4 pointer-events-none" style="display:none;">
            <div class="w-full h-full border-2 border-purple-400 rounded-lg shadow-[0_0_20px_rgba(168,85,247,0.5)]">
                <!-- Corner markers -->
                <div class="absolute -top-1 -left-1 w-10 h-10 border-t-4 border-l-4 border-purple-500 rounded-tl-lg"></div>
                <div class="absolute -top-1 -right-1 w-10 h-10 border-t-4 border-r-4 border-purple-500 rounded-tr-lg"></div>
                <div class="absolute -bottom-1 -left-1 w-10 h-10 border-b-4 border-l-4 border-purple-500 rounded-bl-lg"></div>
                <div class="absolute -bottom-1 -right-1 w-10 h-10 border-b-4 border-r-4 border-purple-500 rounded-br-lg"></div>
            </div>
            <!-- Scan line animation -->
            <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-purple-500 to-transparent animate-pulse"></div>
        </div>
    </div>

    <!-- Controls -->
    <div class="space-y-3 mb-6">
        <div class="flex gap-3">
            <button id="startBtn" class="flex-1 bg-purple-600 text-white px-6 py-3 rounded-lg font-bold shadow-lg hover:bg-purple-700 transition flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
                Start Camera
            </button>
            <button id="captureBtn" class="flex-1 bg-pink-600 text-white px-6 py-3 rounded-lg font-bold shadow-lg hover:bg-pink-700 transition flex items-center justify-center" style="display:none;">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                Capture & Identify
            </button>
        </div>
        <button id="stopBtn" class="w-full bg-gray-600 text-white px-6 py-3 rounded-lg font-medium shadow hover:bg-gray-700 transition" style="display:none;">
            Stop Camera
        </button>
    </div>
    
    <!-- Status Messages -->
    <div id="statusMessage" class="text-center text-sm text-gray-600 mb-6"></div>
    
    <!-- Results Panel -->
    <div id="resultsPanel" class="glass-panel p-6" style="display:none;">
        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
            <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            AI Identification Result
        </h3>
        
        <!-- Identified Phone Info -->
        <div id="identifiedInfo" class="mb-4">
            <div class="flex items-center space-x-4 p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border border-purple-200">
                <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                    </svg>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Detected Phone</p>
                    <p id="detectedBrand" class="font-semibold text-gray-900"></p>
                    <p id="detectedModel" class="text-lg font-bold text-purple-700"></p>
                    <p id="detectedConfidence" class="text-xs text-gray-500 mt-1"></p>
                </div>
            </div>
        </div>
        
        <!-- Not Identified Message -->
        <div id="notIdentified" class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg" style="display:none;">
            <div class="flex items-center">
                <svg class="w-5 h-5 text-yellow-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                <span class="text-yellow-800 font-medium">Could not identify the phone</span>
            </div>
            <p id="notIdentifiedDetails" class="text-sm text-yellow-700 mt-1"></p>
        </div>
        
        <!-- Matched Product Card -->
        <div id="matchedProduct" class="border border-green-200 bg-green-50 rounded-lg p-4" style="display:none;">
            <div class="flex items-center mb-3">
                <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="font-semibold text-green-800">Found in Database!</span>
            </div>
            
            <div class="bg-white rounded-lg p-4 border border-green-200">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <p id="productCompany" class="text-sm text-gray-500"></p>
                        <p id="productName" class="text-xl font-bold text-gray-900"></p>
                    </div>
                    <div id="productScore" class="text-right">
                        <!-- Score badge -->
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-3 text-center mb-4">
                    <div class="bg-gray-50 rounded-lg p-2">
                        <p class="text-xs text-gray-500">RAM</p>
                        <p id="productRam" class="font-bold text-gray-900"></p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-2">
                        <p class="text-xs text-gray-500">Storage</p>
                        <p id="productStorage" class="font-bold text-gray-900"></p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-2">
                        <p class="text-xs text-gray-500">Battery</p>
                        <p id="productBattery" class="font-bold text-gray-900"></p>
                    </div>
                </div>
                
                <a id="viewProductBtn" href="#" class="block w-full text-center bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700 transition">
                    View Full Details & Reviews
                </a>
            </div>
        </div>
        
        <!-- No Match Found -->
        <div id="noMatch" class="border border-orange-200 bg-orange-50 rounded-lg p-4" style="display:none;">
            <div class="flex items-start">
                <svg class="w-5 h-5 mr-2 mt-0.5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                <div>
                    <span class="font-semibold text-orange-800">Phone Not Found in Database</span>
                    <p class="text-sm text-orange-700 mt-1">The AI detected "<span id="noMatchPhone"></span>" but this phone model is not registered in our system yet.</p>
                </div>
            </div>
        </div>
        
        <!-- Try Again Button -->
        <button id="tryAgainBtn" class="w-full mt-4 bg-purple-100 text-purple-700 py-2 rounded-lg font-medium hover:bg-purple-200 transition">
            Scan Another Phone
        </button>
    </div>
    
    <!-- Also try QR scan link -->
    <div class="text-center mt-6">
        <a href="{{ url_for('consumer_scan') }}" class="text-gray-500 hover:text-blue-600 text-sm">
            Or scan a QR code instead →
        </a>
    </div>
</div>

<script>
let video = document.getElementById('videoElement');
let canvas = document.getElementById('canvasElement');
let ctx = canvas.getContext('2d');
let stream = null;

const startBtn = document.getElementById('startBtn');
const captureBtn = document.getElementById('captureBtn');
const stopBtn = document.getElementById('stopBtn');
const placeholder = document.getElementById('placeholder');
const scanFrame = document.getElementById('scanFrame');
const scanningOverlay = document.getElementById('scanningOverlay');
const statusMessage = document.getElementById('statusMessage');
const resultsPanel = document.getElementById('resultsPanel');

// Start Camera
startBtn.addEventListener('click', async function() {
    try {
        statusMessage.textContent = 'Requesting camera access...';
        
        stream = await navigator.mediaDevices.getUserMedia({
            video: { 
                facingMode: 'environment',
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        });
        
        video.srcObject = stream;
        video.style.display = 'block';
        placeholder.style.display = 'none';
        scanFrame.style.display = 'block';
        startBtn.style.display = 'none';
        captureBtn.style.display = 'flex';
        stopBtn.style.display = 'block';
        resultsPanel.style.display = 'none';
        
        statusMessage.textContent = 'Camera ready! Point at a phone and click "Capture & Identify"';
        statusMessage.className = 'text-center text-sm text-green-600 mb-6';
        
    } catch (err) {
        console.error('Camera error:', err);
        statusMessage.textContent = 'Error: ' + (err.message || 'Could not access camera');
        statusMessage.className = 'text-center text-sm text-red-600 mb-6';
    }
});

// Capture and Identify
captureBtn.addEventListener('click', async function() {
    if (!stream) return;
    
    // Capture frame
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);
    
    // Get base64 image
    const imageData = canvas.toDataURL('image/jpeg', 0.8);
    
    // Show scanning overlay
    scanningOverlay.style.display = 'flex';
    captureBtn.disabled = true;
    statusMessage.textContent = 'AI is analyzing the image...';
    statusMessage.className = 'text-center text-sm text-purple-600 mb-6';
    
    try {
        const response = await fetch('/api/identify-phone', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ image: imageData })
        });
        
        const result = await response.json();
        
        // Hide scanning overlay
        scanningOverlay.style.display = 'none';
        captureBtn.disabled = false;
        
        // Show results
        displayResults(result);
        
    } catch (err) {
        console.error('API error:', err);
        scanningOverlay.style.display = 'none';
        captureBtn.disabled = false;
        statusMessage.textContent = 'Error: Could not analyze image. Please try again.';
        statusMessage.className = 'text-center text-sm text-red-600 mb-6';
    }
});

// Display Results
function displayResults(result) {
    resultsPanel.style.display = 'block';
    
    const identifiedInfo = document.getElementById('identifiedInfo');
    const notIdentified = document.getElementById('notIdentified');
    const matchedProduct = document.getElementById('matchedProduct');
    const noMatch = document.getElementById('noMatch');
    
    // Reset all
    identifiedInfo.style.display = 'none';
    notIdentified.style.display = 'none';
    matchedProduct.style.display = 'none';
    noMatch.style.display = 'none';
    
    if (result.error) {
        notIdentified.style.display = 'block';
        document.getElementById('notIdentifiedDetails').textContent = result.error;
        statusMessage.textContent = 'Error identifying phone';
        statusMessage.className = 'text-center text-sm text-red-600 mb-6';
        return;
    }
    
    if (result.identified) {
        identifiedInfo.style.display = 'block';
        document.getElementById('detectedBrand').textContent = result.brand || 'Unknown';
        document.getElementById('detectedModel').textContent = result.model || 'Unknown Model';
        document.getElementById('detectedConfidence').textContent = 
            `Confidence: ${result.confidence || 'N/A'} • ${result.details || ''}`;
        
        if (result.matched && result.product) {
            matchedProduct.style.display = 'block';
            const p = result.product;
            
            document.getElementById('productCompany').textContent = p.company;
            document.getElementById('productName').textContent = p.name;
            document.getElementById('productRam').textContent = p.ram_gb ? p.ram_gb + ' GB' : 'N/A';
            document.getElementById('productStorage').textContent = p.storage_gb ? p.storage_gb + ' GB' : 'N/A';
            document.getElementById('productBattery').textContent = p.battery_mah ? p.battery_mah + ' mAh' : 'N/A';
            document.getElementById('viewProductBtn').href = p.url;
            
            // Score badge
            const scoreDiv = document.getElementById('productScore');
            if (p.ideal_score) {
                const scoreColor = p.ideal_score >= 80 ? 'green' : p.ideal_score >= 60 ? 'yellow' : 'red';
                scoreDiv.innerHTML = `
                    <div class="text-sm text-gray-500">CrediScore</div>
                    <div class="text-2xl font-bold text-${scoreColor}-600">${p.ideal_score.toFixed(1)}</div>
                `;
            }
            
            statusMessage.textContent = 'Phone identified and found in database!';
            statusMessage.className = 'text-center text-sm text-green-600 mb-6';
        } else {
            noMatch.style.display = 'block';
            // Show the detected phone name in the not found message
            const detectedPhone = (result.brand || '') + ' ' + (result.model || '');
            document.getElementById('noMatchPhone').textContent = detectedPhone.trim() || 'Unknown phone';
            statusMessage.textContent = 'Phone identified but not in our database';
            statusMessage.className = 'text-center text-sm text-orange-600 mb-6';
        }
    } else {
        notIdentified.style.display = 'block';
        document.getElementById('notIdentifiedDetails').textContent = 
            result.details || 'Try positioning the phone clearly in frame';
        statusMessage.textContent = 'Could not identify the phone';
        statusMessage.className = 'text-center text-sm text-yellow-600 mb-6';
    }
}

// Stop Camera
stopBtn.addEventListener('click', function() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }
    video.style.display = 'none';
    placeholder.style.display = 'flex';
    scanFrame.style.display = 'none';
    startBtn.style.display = 'flex';
    captureBtn.style.display = 'none';
    stopBtn.style.display = 'none';
    statusMessage.textContent = '';
});

// Try Again
document.getElementById('tryAgainBtn').addEventListener('click', function() {
    resultsPanel.style.display = 'none';
    statusMessage.textContent = 'Point at another phone and click "Capture & Identify"';
    statusMessage.className = 'text-center text-sm text-green-600 mb-6';
});
</script>
{% endblock %}
